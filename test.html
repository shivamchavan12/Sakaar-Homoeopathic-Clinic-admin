<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sakaar Homoeopathic Clinic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body class="bg-white text-maroon-800 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-red-800 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex items-center justify-between py-4 px-6 flex-wrap">
            <a href="index.html" class="flex items-center group">
                <img src="logo.png" alt="Clinic Logo" class="w-12 h-12 rounded-full object-cover mr-4">
                <span class="text-3xl font-extrabold tracking-wide relative group hover:text-yellow-400 transition duration-300">
                    Sakaar Homoeopathic Clinic
                    <span class="absolute bottom-0 left-0 w-full h-0.5 bg-white scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></span>
                </span>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto my-8 flex-grow px-4">
        <div class="bg-white p-6 shadow rounded-lg">
            <h2 class="text-2xl font-semibold mb-4 text-red-800">Appointment Requests</h2>
            
            <!-- Table for displaying appointments -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                    <thead>
                        <tr class="bg-gray-100 text-left text-sm font-semibold">
                            <th class="py-2 px-4 border-b">Name</th>
                            <th class="py-2 px-4 border-b">Email</th>
                            <th class="py-2 px-4 border-b">Phone No.</th>
                            <th class="py-2 px-4 border-b">Date</th>
                            <th class="py-2 px-4 border-b">Time</th>
                            <th class="py-2 px-4 border-b">Age</th>
                            <th class="py-2 px-4 border-b">Gender</th>
                            <th class="py-2 px-4 border-b">Status</th>
                            <th class="py-2 px-4 border-b">Complaints</th>
                            <th class="py-2 px-4 border-b">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointments">
                        <!-- Appointments will be dynamically populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    <div class="flex justify-end mb-4">
        <button id="updateOfflineAppointmentsBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
            Update All Offline Appointments
        </button>
    </div>
    
    <!-- Modal for entering appointment details -->
    <div id="appointmentModal" class="fixed inset-0 flex justify-center items-center bg-gray-500 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h3 class="text-2xl mb-4 text-center text-gray-800">Enter Appointment Details</h3>
    
            <form id="appointmentForm">
                <label for="name" class="block text-sm font-medium">Name:</label>
                <input type="text" id="name" class="w-full p-2 mt-2 border border-gray-300 rounded" required>
    
                <label for="email" class="block text-sm font-medium mt-4">Email:</label>
                <input type="email" id="email" class="w-full p-2 mt-2 border border-gray-300 rounded" required>
    
                <label for="phone" class="block text-sm font-medium mt-4">Phone:</label>
                <input type="text" id="phone" class="w-full p-2 mt-2 border border-gray-300 rounded" required>
    
                <label for="date" class="block text-sm font-medium mt-4">Date (DD-MM-YYYY):</label>
                <input type="text" id="date" class="w-full p-2 mt-2 border border-gray-300 rounded" required>
    
                <label for="time" class="block text-sm font-medium mt-4">Time:</label>
                <input type="text" id="time" class="w-full p-2 mt-2 border border-gray-300 rounded" required>
    
                <label for="age" class="block text-sm font-medium mt-4">Age:</label>
                <input type="number" id="age" class="w-full p-2 mt-2 border border-gray-300 rounded" required>
    
                <label for="gender" class="block text-sm font-medium mt-4">Gender:</label>
                <select id="gender" class="w-full p-2 mt-2 border border-gray-300 rounded" required>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
    
                <label for="complaints" class="block text-sm font-medium mt-4">Complaints:</label>
                <textarea id="complaints" class="w-full p-2 mt-2 border border-gray-300 rounded"></textarea>
    
                <div class="flex justify-end mt-6">
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Submit</button>
                    <button type="button" id="closeModalBtn" class="ml-4 bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">Close</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Footer -->
    <footer class="bg-gray-200 text-black text-center p-4 mt-auto">
        <p>Â© Sakaar Homoeopathic Clinic</p>
    </footer>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, updateDoc, doc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBZvBHPp6bzmBaTaQBQ8JBsgTKM12dtEjM",
        authDomain: "sakaar-homoeopathic-clinic.firebaseapp.com",
        projectId: "sakaar-homoeopathic-clinic",
        storageBucket: "sakaar-homoeopathic-clinic.appspot.com",
        messagingSenderId: "1028319469",
        appId: "1:1028319469:web:e449a194c35adaf1a884e4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Modal and Form Elements
    const modal = document.getElementById('appointmentModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const updateOfflineAppointmentsBtn = document.getElementById('updateOfflineAppointmentsBtn');
    const appointmentForm = document.getElementById('appointmentForm');

    // Function to get the current date in 'dd-mm-yyyy' format
    function getCurrentDate() {
        const date = new Date();
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
    }

    // Load all appointments and display them in the table
    async function loadAppointments() {
        const appointmentsContainer = document.getElementById('appointments');
        appointmentsContainer.innerHTML = '<tr><td colspan="10" class="text-center py-4">Loading...</td></tr>';

        const appointmentsSnapshot = await getDocs(collection(db, "appointments"));
        let appointments = [];

        appointmentsSnapshot.forEach(docSnapshot => {
            const data = docSnapshot.data();
            appointments.push({
                id: docSnapshot.id,
                ...data
            });
        });

        // Sort appointments by date
        appointments.sort((a, b) => new Date(a.date) - new Date(b.date));

        appointmentsContainer.innerHTML = '';  // Clear loading text

        appointments.forEach(appointment => {
            const appointmentRow = document.createElement('tr');
            appointmentRow.className = "text-sm";

            appointmentRow.innerHTML = `
                <td class="py-2 px-4 border-b">${appointment.name}</td>
                <td class="py-2 px-4 border-b">${appointment.email}</td>
                <td class="py-2 px-4 border-b">${appointment.phone}</td>
                <td class="py-2 px-4 border-b">${appointment.date}</td>
                <td class="py-2 px-4 border-b">${appointment.time}</td>
                <td class="py-2 px-4 border-b">${appointment.age}</td>
                <td class="py-2 px-4 border-b">${appointment.gender}</td>
                <td class="py-2 px-4 border-b"><span class="font-semibold" id="status-${appointment.id}">${appointment.status}</span></td>
                <td class="py-2 px-4 border-b">${appointment.complaints || 'N/A'}</td>
                <td class="py-2 px-4 border-b">
                    <button class="accept-btn bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" data-id="${appointment.id}">Accept</button>
                    <button class="decline-btn bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 mt-2">Decline</button>
                </td>
            `;

            const acceptBtn = appointmentRow.querySelector('.accept-btn');
            const declineBtn = appointmentRow.querySelector('.decline-btn');
            const statusSpan = appointmentRow.querySelector(`#status-${appointment.id}`);

            acceptBtn.addEventListener('click', async () => {
                const confirmAccept = confirm("Are you sure you want to accept this appointment?");
                if (confirmAccept) {
                    await updateDoc(doc(db, "appointments", appointment.id), { status: 'Accepted' });
                    statusSpan.textContent = 'Accepted';
                    statusSpan.classList.add('text-green-600');
                    statusSpan.classList.remove('text-red-600');
                }
            });

            declineBtn.addEventListener('click', async () => {
                const confirmDecline = confirm("Are you sure you want to decline this appointment?");
                if (confirmDecline) {
                    await updateDoc(doc(db, "appointments", appointment.id), { status: 'Declined' });
                    statusSpan.textContent = 'Declined';
                    statusSpan.classList.add('text-red-600');
                    statusSpan.classList.remove('text-green-600');
                }
            });

            appointmentsContainer.appendChild(appointmentRow);
        });
    }

    // Open modal when the button is clicked
    updateOfflineAppointmentsBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
    });

    // Close modal when "Close" button is clicked
    closeModalBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    // Handle form submission
    appointmentForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get form data
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const age = document.getElementById('age').value;
        const gender = document.getElementById('gender').value;
        const complaints = document.getElementById('complaints').value;

        // Prepare data for Firestore
        const appointmentData = {
            name,
            email,
            phone,
            date,
            time,
            age,
            gender,
            status: 'Offline',
            complaints
        };

        try {
            // Add new appointment to Firestore
            await setDoc(doc(collection(db, "appointments")), appointmentData);
            
            // Close modal
            modal.classList.add('hidden');

            // Reset form fields
            appointmentForm.reset();

            // Reload the table to reflect the new appointment
            loadAppointments();
        } catch (error) {
            console.error("Error adding appointment: ", error);
            alert("There was an error adding the appointment.");
        }
    });

    // Load appointments on page load
    loadAppointments();
</script>
    
</body>
</html>
